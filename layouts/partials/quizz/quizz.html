<div class="container" id="quizz">
    {{ range .Pages }}
    <a href="{{ $.Permalink }}">{{ .Title }}</a>
    {{ end }}

    {{ range $question := (where .Site.Pages "Section" "question") }}
      <div id="questionContainer-{{ $question.id }}" style="display:none;">
        <span  id="question-{{ $question.id }}">{{ $question.text }}</span>
        <div>
          {{ range $index, $choice := $question.choices }}
            <input class="radio" type="radio" name="reponse" value="{{ $choice.score }}" id="{{ $question.text | urlize }}-{{ $index }}">
            <label for="">{{ $choice.text }}</label>
          {{ end }}
        </div>
        <div>
          <button class="quizz-validation-btn">Valider</button>
        </div>
      </div>
    {{end}}
</div>

<script>
  window.addEventListener('DOMContentLoaded', startQuizz);

  async function startQuizz() {
    const response = await fetch('/questions/index.json');
    const questions =  (await response.json()).data;

    console.log(questions);
    initQuizz(questions);

    document.querySelectorAll('.quizz-validation-btn').forEach(el=>{
      el.addEventListener('click', ()=>{
        checkAnswer(questions);
      })
    });
  }


  let wrongsAnswer = [];

  let score = 0;
  let questionId = 0;
  let step = 0;



  function showResult() {
    document.querySelector("#quizz").classList.toggle("hidden");
    document.querySelector("#result").classList.toggle("hidden");
    const eltScore = document.querySelector("#score");
    eltScore.innerHTML = score;
  }

  function initQuizz(questions){
    questions.map(question => {
      if(questionId == question.id){
          document.getElementById(`questionContainer-${questionId}`).style.display = "block";
        }
    })
  }


  function checkAnswer(questions){
    const answer = document.querySelector("input:checked");
    if (answer == null) {
      alert("veuillez selectionner une r√©ponse !!")
      return;
    }
    else{
      answer.checked = false;
      if(answer.value == 0 && ! wrongsAnswer.includes(questionId)){
        wrongsAnswer.push(questionId);
      }
      else{
        score += +answer.value;
      }
      changeQuestion(questions);
    }
  }

  function changeQuestion(questions){
    questionId+= 1;
    step++;
    for (let i = 0; i < questions.length; i++) {
      if (questionId == questions[i].id) {
        document.getElementById(`questionContainer-${questionId}`).style.display = "block";
      }
      else{
          document.getElementById(`questionContainer-${i}`).style.display = "none";
      }
    }
    if(step == questions.length){
      showResult();
    }
  }




</script>
